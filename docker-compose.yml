x-defaults: &default-env
  PYTHONDONTWRITEBYTECODE: 1
  PYTHONUNBUFFERED: 1
  PIP_NO_CACHE_DIR: 1
  PIP_DISABLE_PIP_VERSION_CHECK: 1

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: mangetamain_app
    ports:
      - "8501:8501"
    environment:
      <<: *default-env
      PYTHONPATH: .
      STREAMLIT_CACHE_DIR: /app/.streamlit/cache
    volumes:
      - ./src:/app/src
      - ./docs:/app/docs
      - ./.streamlit:/app/.streamlit
    restart: unless-stopped

  tests:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: mangetamain_tests
    depends_on:
      - app
    environment:
      <<: *default-env
      PYTHONPATH: /app/src
    command: >-
      python -m pytest --cov=src --cov-report=term-missing --cov-report=xml --cov-fail-under=90
    volumes:
      - ./src:/app/src
      - ./tests:/app/tests
    profiles:
      - test

  lint:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: mangetamain_lint
    command: >-
      sh -c "black --check src tests && ruff check src tests"
    volumes:
      - ./src:/app/src
      - ./tests:/app/tests
    profiles:
      - lint
